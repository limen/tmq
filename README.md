
# TMQ: Timing Message Queue

定时消息队列

## 场景

需要延时发送消息的场景，如

+ 新用户注册，第二天9点发送促销信息
+ 用户下单，半小时后提醒用户付款

## 目标

根据以上场景，相比普通的消息队列，TMQ需要增加以下特性

+ 每个消息都有投递时间
+ 可以按投递时间高效获取消息

按投递时间高效获取消息是我们的主要目标

## 方案

### 方案1

给投递时间加索引。按投递时间查询，并按自增ID顺序获取。

存在的问题

+ 当一个投递时间有大量消息时，索引是低效的

### 方案2

采用分表策略，基于投递时间横向拆分。

存在的问题

+ 表数量不可控
+ 表数量太多会影响数据库性能

### 方案3

虽然分表策略不可取，我们依然可以按投递时间分割数据，以提升查询性能。

使用MySQL + Redis实现，MySQL作为消息的持久存储层，Redis按时间分片存储消息ID。

优势

- Redis LIST 原子化的``push``, ``pop``命令
- 高性能：Redis内存操作 + MySQL唯一索引查询

## API

### 投递消息

```
push(MessageInterface msg)
```

### 拉取消息
```
pull(Date t)
```

### 查询消息
```
poll(String msgId)
```

### 更新消息
```
consumed(MessageInterface msg)
```
